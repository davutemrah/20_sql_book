# Adhoc solutions


## DATA QA EFFORTS

### COUNTS

```sql
SELECT
    COUNT(*) AS NUM_ROWS,
    COUNT(DISTINCT ID) AS DISTINCT_ID_COUNT,
    COUNT(DISTINCT HHID) AS DISTINCT_HHID_COUNT,
    
    COUNT_IF(ID IS NOT NULL) AS VALID_ID_COUNT,
    COUNT_IF(HHID IS NOT NULL) AS VALID_HHID_COUNT
FROM DATA_TABLE
```


## Balancing Weights

```sql
WITH CENSUS AS (

SELECT
    AGE_BIN, INCOME_BIN, GENDER_BIN,
    SUM(PERWT) AS TARGET,
    ROW_NUMBER() OVER(ORDER BY AGE_BIN, INCOME_BIN, GENDER_BIN) AS SEGMENTS
FROM CENSUS
GROUP BY AGE_BIN, INCOME_BIN, GENDER_BIN
),
ID_TABLE AS (
SELECT 
    DISTINCT ID,
    AGE_BIN, INCOME_BIN, GENDER_BIN,
    COUNT(DISTINCT ID) OVER()::DOUBLE PRECISION AS SAMPLE_SIZE
FROM POPULATION_TABLE
WHERE AGE_BIN IS NOT NULL
  AND INCOME_BIN IS NOT NULL
  AND GENDER_BIN IS NOT NULL
),
FINAL AS (

SELECT
    ID,
    AGE_BIN, INCOME_BIN, GENDER_BIN,
    B.SEGMENTS,
    B.TARGET*(SAMPLE_SIZE/B.TOTAL_POP) AS NORMALIZED_TARGETS,
    COUNT(*) OVER(PARTITION BY B.SEGMENTS ORDER BY NULL) AS SEGMENT_COUNTS,
    NORMALIZED_TARGETS/SEGMENT_COUNTS AS WEIGHT,
    B.TARGET_COUNTS/SEGMENT_COUNTS AS POP_WEIGHT
FROM ID_TABLE A
INNER JOIN CENSUS B
  ON A.AGE_BIN = B.AGE_BIN
  AND A.INCOME_BIN = B.INCOME_BIN 
  AND C.GENDER_BIN = B.GENDER_BIN
ORDER BY SEGMENTS
)
SELECT ID, WEIGHT, POP_WEIGHT
FROM FINAL
ORDER BY ID
```


## Weighted Sampling


### Solution


```sql
WITH ONE AS (
  SELECT 1 AS CHILDCARE, 0.17 AS CHILD
  UNION ALL
  SELECT 0 AS CHILDCARE, 0.83 AS CHILD
),
TWO AS (
  SELECT 1 AS SENIOR_CARE, 0.3 AS SENIOR
  UNION ALL
  SELECT 0 AS SENIOR_CARE, 0.7 AS SENIOR
),
THREE AS (
  SELECT 1 AS TUTORING, 0.22 AS TUTOR
  UNION ALL
  SELECT 0 AS TUTORING, 0.78 AS TUTOR
),
TARGET_COUNTS AS (
  SELECT 
      CHILDCARE,
      SENIOR_CARE,
      TUTORING,
      ROW_NUMBER() OVER (ORDER BY CHILDCARE, SENIOR_CARE, TUTORING) AS SEGMENTS,
      ROUND(CHILD*SENIOR*TUTOR*6000000) AS TARGET_COUNT
  FROM ONE, TWO, THREE
)
SELECT
    A.*,
    COUNT(*) OVER(PARTITION BY B.SEGMENTS ORDER BY NULL) AS ID_COUNTS,
    (B.TARGET_COUNT/BLU_COUNTS) AS WEIGHT
FROM TABLE_AUDIENCE A
INNER JOIN TARGET_COUNTS B
  ON A.CHILD_CARE=B.CHILD_CARE
  AND A.SENIOR_CARE=B.SENIOR_CARE
  AND A.TUTORING=B.TUTORING
ORDER BY SEGMENTS

```


## Demographic Distribution

Assuming TABLE_POPULATION is distinct on ID column.

```sql
SELECT
    AGE_CATEGORY, 
    COUNT(ID) AS RAW_COUNT,
    SUM(COUNT(ID)) OVER() AS TOTAL_COUNTS,
    COUNT(ID) / SUM(COUNT(ID)) OVER() AS PCT_DIST,
    
    SUM(WEIGHT) AS WEIGHTED_COUNT,
    SUM(SUM(WEIGHT)) OVER() AS WEIGHTED_TOTAL_COUNTS,
    SUM(WEIGHT) / SUM(SUM(WEIGHT)) OVER() AS WEIGHTED_PCT_DIST
FROM TABLE_POPULATION
GROUP BY AGE_CATEGORY
```








